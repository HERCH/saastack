extern alias Generators;
using System.Reflection;
using FluentAssertions;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Xunit;
using MinimalApiMediatRGenerator = Generators::Tools.Generators.Web.Api.MinimalApiMediatRGenerator;
using UsedImplicitly = Generators::JetBrains.Annotations.UsedImplicitlyAttribute;

namespace Tools.Generators.Web.Api.UnitTests;

[UsedImplicitly]
public class MinimalApiMediatRGeneratorSpec
{
    private static readonly string[]
        AdditionalCompilationAssemblies =
        [
            "System.Runtime.dll",
            "netstandard.dll"
        ]; //HACK: required to analyze custom attributes

    private static CSharpCompilation CreateCompilation(string sourceCode)
    {
        var assemblyPath = Path.GetDirectoryName(typeof(object).Assembly.Location)!;

        var references = new List<MetadataReference>
        {
            MetadataReference.CreateFromFile(typeof(MinimalApiMediatRGenerator).Assembly.Location),
            MetadataReference.CreateFromFile(typeof(Binder).GetTypeInfo().Assembly.Location)
        };
        AdditionalCompilationAssemblies.ToList()
            .ForEach(item => references.Add(MetadataReference.CreateFromFile(Path.Combine(assemblyPath, item))));
        var compilation = CSharpCompilation.Create("compilation",
            new[]
            {
                CSharpSyntaxTree.ParseText(sourceCode)
            },
            references,
            new CSharpCompilationOptions(OutputKind.ConsoleApplication));

        return compilation;
    }

    [Trait("Category", "Unit")]
    public class GivenAServiceClass
    {
        private GeneratorDriver _driver;

        public GivenAServiceClass()
        {
            var generator = new MinimalApiMediatRGenerator();
            _driver = CSharpGeneratorDriver.Create(generator);
        }

        [Fact]
        public void WhenDefinesNoMethods_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                    
                        }
                    }
                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodWithNakedReturnType_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public string AMethod(ARequest request)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            await Task.CompletedTask;
                            var api = new global::ANamespace.AServiceClass();
                            var result = api.AMethod(request);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodWithAsyncTaskReturnTypeAndNoCancellationToken_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodWithAsyncTaskReturnTypeAndCancellationToken_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodAndTestingOnly_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, isTestingOnly:true)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                #if TESTINGONLY
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                #endif
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                #if TESTINGONLY
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }
                #endif

                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodAndHMACAuth_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, access:AccessType.HMAC, isTestingOnly:true)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                #if TESTINGONLY
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("HMAC")
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                #endif
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                #if TESTINGONLY
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }
                #endif

                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodAndTokenAuth_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, access:AccessType.Token, isTestingOnly:true)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                #if TESTINGONLY
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                #endif
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                #if TESTINGONLY
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }
                #endif

                }


                """);
        }

        [Fact]
        public void WhenDefinesAMethodAndClassConstructor_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Application.Interfaces;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    private readonly ICallerContextFactory _callerFactory;
                                                    
                                                    public CarsApi(ICallerContextFactory callerFactory)
                                                    {
                                                        _callerFactory = callerFactory;
                                                        _carsApplication = carsApplication;
                                                    }
                                                
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;
                using Application.Interfaces;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        private readonly global::System.IServiceProvider _serviceProvider;
                
                        public AMethod_ARequest_Handler(global::System.IServiceProvider serviceProvider)
                        {
                            _serviceProvider = serviceProvider;
                        }
                
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var callerFactory = _serviceProvider.GetRequiredService<<global namespace>.ICallerContextFactory>();
                
                            var api = new global::ANamespace.AServiceClass(callerFactory);
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesARequestWithMultipleAuthorizeAttributes_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, access:AccessType.Token, isTestingOnly:true)]
                                                [Authorize(Roles.Platform_Standard, Features.Platform_Basic)]
                                                [Authorize(Roles.Platform_Operations, Features.Platform_PaidTrial)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                #if TESTINGONLY
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}POLICY:{|Features|:{|Platform|:[|paidtrial_features|]},|Roles|:{|Platform|:[|platform_operations|]}}")
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                #endif
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                #if TESTINGONLY
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }
                #endif

                }


                """);
        }

        [Fact]
        public void WhenDefinesARequestWithSingleAuthorizeAttribute_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, access:AccessType.Token, isTestingOnly:true)]
                                                [Authorize(Roles.Platform_Standard, Features.Platform_Basic)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                #if TESTINGONLY
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}")
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                #endif
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                #if TESTINGONLY
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }
                #endif

                }


                """);
        }

        [Fact]
        public void WhenDefinesARequestThatIsTenanted_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, access:AccessType.Token)]
                                                [Authorize(Roles.Platform_Standard, Features.Platform_Basic)]
                                                public class ARequest : IWebRequest<AResponse>, ITenantedRequest
                                                {
                                                    public string? OrganizationId { get; set; }
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.MultiTenancyFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}")
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesAPostRequestThatIsIHasMultipartForm_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Post, access:AccessType.Token)]
                                                [Authorize(Roles.Platform_Standard, Features.Platform_Basic)]
                                                public class ARequest : IWebRequest<AResponse>, IHasMultipartForm
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapPost("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Mvc.FromForm] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}")
                                .DisableAntiforgery()
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Post);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesAPutPatchRequestThatIsIHasMultipartForm_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.PutPatch, access:AccessType.Token)]
                                                [Authorize(Roles.Platform_Standard, Features.Platform_Basic)]
                                                public class ARequest : IWebRequest<AResponse>, IHasMultipartForm
                                                {
                                                }
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup(string.Empty)
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                            aserviceclassGroup.MapPut("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Mvc.FromForm] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}")
                                .DisableAntiforgery()
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A (Put)";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                            aserviceclassGroup.MapPatch("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Mvc.FromForm] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}")
                                .DisableAntiforgery()
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A (Patch)";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.PutPatch);
                        }
                    }

                }


                """);
        }

        [Fact]
        public void WhenDefinesAWebServiceAttribute_ThenGenerates()
        {
            var compilation = CreateCompilation("""
                                                using System;
                                                using System.Threading;
                                                using Infrastructure.Web.Api.Interfaces;

                                                namespace ANamespace;

                                                public class AResponse : IWebResponse
                                                {
                                                }
                                                [Route("aroute", OperationMethod.Get, access:AccessType.Token, isTestingOnly:true)]
                                                [Authorize(Roles.Platform_Standard, Features.Platform_Basic)]
                                                public class ARequest : IWebRequest<AResponse>
                                                {
                                                }
                                                [WebService("aprefix")]
                                                public class AServiceClass : IWebApiService
                                                {
                                                    public async Task<string> AMethod(ARequest request, CancellationToken cancellationToken)
                                                    {
                                                         return "";
                                                    }
                                                }
                                                """);

            var result = Generate(compilation);

            result.Should().Be(
                """
                // <auto-generated/>
                using System.Threading;
                using System;
                using Microsoft.Extensions.DependencyInjection;
                using Microsoft.AspNetCore.Http;
                using Microsoft.AspNetCore.Builder;
                using Infrastructure.Web.Api.Interfaces;
                using Infrastructure.Web.Api.Common.Extensions;

                namespace compilation
                {
                    public static class MinimalApiRegistration
                    {
                        public static void RegisterRoutes(this global::Microsoft.AspNetCore.Builder.WebApplication app)
                        {
                            var aserviceclassGroup = app.MapGroup("aprefix")
                                .WithTags("AServiceClass")
                                .RequireCors("__DefaultCorsPolicy")
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ApiUsageFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.RequestCorrelationFilter>()
                                .AddEndpointFilter<global::Infrastructure.Web.Api.Common.Endpoints.ContentNegotiationFilter>();
                #if TESTINGONLY
                            aserviceclassGroup.MapGet("aroute",
                                async (global::MediatR.IMediator mediator, [global::Microsoft.AspNetCore.Http.AsParameters] global::ANamespace.ARequest request) =>
                                     await mediator.Send(request, global::System.Threading.CancellationToken.None))
                                .RequireAuthorization("Token")
                                .RequireCallerAuthorization("POLICY:{|Features|:{|Platform|:[|basic_features|]},|Roles|:{|Platform|:[|platform_standard|]}}")
                                .WithOpenApi(op =>
                                    {
                                        op.OperationId = "A";
                                        op.Description = "(request type: ARequest)";
                                        op.Responses.Clear();
                                        return op;
                                    });
                #endif
                
                        }
                    }
                }

                namespace ANamespace.AServiceClassMediatRHandlers
                {
                #if TESTINGONLY
                    public class AMethod_ARequest_Handler : global::MediatR.IRequestHandler<global::ANamespace.ARequest, global::Microsoft.AspNetCore.Http.IResult>
                    {
                        public async Task<global::Microsoft.AspNetCore.Http.IResult> Handle(global::ANamespace.ARequest request, global::System.Threading.CancellationToken cancellationToken)
                        {
                            var api = new global::ANamespace.AServiceClass();
                            var result = await api.AMethod(request, cancellationToken);
                            return result.HandleApiResult(global::Infrastructure.Web.Api.Interfaces.OperationMethod.Get);
                        }
                    }
                #endif

                }


                """);
        }

        private string Generate(CSharpCompilation compilation)
        {
            _driver = _driver.RunGeneratorsAndUpdateCompilation(compilation, out var _, out var _);
            return _driver.GetRunResult().Results[0].GeneratedSources[0].SourceText.ToString();
        }
    }
}